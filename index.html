<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>ãƒ—ãƒ­ç”¨éŸ³ç¨‹å­¦ç¿’ãƒãƒ¥ãƒ¼ãƒŠãƒ¼</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{
  height:100%;
  font-family:-apple-system,BlinkMacSystemFont,'Hiragino Sans',sans-serif;
  background:#0d0f1a;color:#fff;overflow:hidden;
  -webkit-user-select:none;user-select:none;
  -webkit-tap-highlight-color:transparent;
  -webkit-text-size-adjust:100%;
}

/* === Layout === */
#app{display:flex;flex-direction:column;height:100%;padding-top:env(safe-area-inset-top)}

/* === Screens === */
.screen{display:none;flex-direction:column;flex:1;min-height:0}
.screen.visible{display:flex}
#startScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;padding:40px 24px}

/* === Start Screen === */
.start-btn{
  width:130px;height:130px;border-radius:65px;
  background:#131630;border:2px solid #4f8cff40;
  color:#4f8cff;font-size:15px;font-weight:600;
  cursor:pointer;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:10px;
  transition:all .15s;font-family:inherit;
}
.start-btn:active{transform:scale(.93);border-color:#4f8cff}
.start-btn svg{width:40px;height:40px}
.start-hint{color:#445;font-size:12px;margin-top:24px;text-align:center;line-height:1.7}
.error-msg{color:#e74c3c;font-size:13px;margin-top:16px;text-align:center;line-height:1.6}

/* === Scene Select === */
.scene-header{text-align:center;padding:20px 16px 12px;font-size:13px;font-weight:600;color:#667;letter-spacing:2px;flex-shrink:0}
.scene-list{flex:1;overflow-y:auto;padding:0 16px 16px;-webkit-overflow-scrolling:touch}
.scene-card{
  background:#161929;border-radius:14px;padding:18px 20px;margin-bottom:10px;
  cursor:pointer;transition:all .15s;border:1.5px solid #1e2140;
}
.scene-card:active{transform:scale(.97);border-color:#4f8cff60}
.scene-card .sc-title{font-size:17px;font-weight:700;margin-bottom:4px}
.scene-card .sc-sub{font-size:12px;color:#667;line-height:1.5}
.scene-card .sc-icon{float:right;font-size:28px;margin:-2px 0 0 12px;opacity:.7}

/* === Main Tuner Screen === */
.header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 16px;flex-shrink:0;
}
.header .h-scene{font-size:14px;font-weight:600;color:#99a}
.header .h-back{
  background:none;border:none;color:#4f8cff;font-size:13px;font-weight:500;
  cursor:pointer;font-family:inherit;padding:4px 8px;
}
.header .h-settings{
  background:none;border:none;color:#667;font-size:20px;
  cursor:pointer;font-family:inherit;padding:4px 8px;
}
.content{flex:1;overflow-y:auto;padding:8px 16px 8px;-webkit-overflow-scrolling:touch}

/* === Card === */
.card{background:#161929;border-radius:14px;padding:18px;margin-bottom:10px}

/* === Zone Bar === */
#zoneCanvas{display:block;margin:0 auto}

/* === Note Display === */
.note-display{text-align:center;padding:8px 0}
.note-kana{font-size:48px;font-weight:800;line-height:1.1}
.note-name{font-size:14px;color:#778;margin-top:4px}
.note-interval{font-size:15px;color:#99a;margin-top:8px;font-weight:500}
.note-cents-row{display:flex;justify-content:center;gap:16px;margin-top:10px;flex-wrap:wrap}
.note-cent-item{font-size:12px;color:#556;text-align:center}
.note-cent-item .cv{font-size:14px;font-weight:600;display:block;margin-top:2px}
.no-sound{color:#445;font-size:16px;text-align:center;padding:30px 0}

/* === Staff === */
#staffCanvas{display:block;margin:0 auto}

/* === Melody/Chord Toggle === */
.toggle-row{
  display:flex;align-items:center;justify-content:center;gap:12px;
  padding:10px 0;
}
.toggle-btn{
  padding:8px 20px;border-radius:20px;font-size:13px;font-weight:600;
  border:1.5px solid #2a2d48;background:#12152a;color:#556;
  cursor:pointer;font-family:inherit;transition:all .15s;
}
.toggle-btn.active{border-color:#4f8cff;background:#4f8cff18;color:#4f8cff}

/* === Learning Card === */
.learn-card{
  background:#1a1e35;border-radius:12px;padding:14px 18px;margin-top:8px;
  font-size:13px;color:#aab;line-height:1.6;
  border-left:3px solid #4f8cff;
  transition:opacity .4s;
}
.learn-card.fade-out{opacity:0}

/* === Settings Screen === */
.settings-back{
  display:flex;align-items:center;gap:6px;
  background:none;border:none;color:#4f8cff;font-size:14px;font-weight:500;
  cursor:pointer;font-family:inherit;padding:12px 16px;
}
.settings-title{text-align:center;font-size:16px;font-weight:700;padding:0 16px 16px;color:#dde}
.setting-group{padding:0 16px;margin-bottom:20px}
.setting-label{font-size:12px;color:#667;font-weight:600;letter-spacing:.5px;margin-bottom:8px}
.setting-options{display:flex;gap:6px;flex-wrap:wrap}
.setting-opt{
  padding:8px 16px;border-radius:10px;font-size:14px;font-weight:600;
  border:1.5px solid #222540;background:#12152a;color:#556;
  cursor:pointer;font-family:inherit;transition:all .15s;
}
.setting-opt.active{border-color:#4f8cff;background:#4f8cff18;color:#4f8cff}
.setting-toggle{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 0;border-bottom:1px solid #1a1d30;
}
.setting-toggle .st-label{font-size:14px;color:#99a}
.switch{
  width:44px;height:26px;border-radius:13px;
  background:#2a2d48;position:relative;cursor:pointer;
  transition:background .2s;border:none;padding:0;
}
.switch.on{background:#4f8cff}
.switch::after{
  content:'';position:absolute;top:3px;left:3px;
  width:20px;height:20px;border-radius:10px;
  background:#fff;transition:transform .2s;
}
.switch.on::after{transform:translateX(18px)}
</style>
</head>
<body>
<div id="app">

  <!-- Start Screen -->
  <div id="startScreen">
    <div style="color:#445;font-size:11px;margin-bottom:20px;letter-spacing:2px;font-weight:600">PRO INTONATION TUNER</div>
    <button class="start-btn" id="startBtn">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M12 2a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z" fill="#4f8cff"/>
        <path d="M17.5 11c0 2.76-2.24 5-5.5 5s-5.5-2.24-5.5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-1.5z" fill="#4f8cff"/>
      </svg>
      ã‚¹ã‚¿ãƒ¼ãƒˆ
    </button>
    <p class="start-hint">ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„</p>
    <p class="error-msg" id="errorMsg" style="display:none"></p>
  </div>

  <!-- Scene Select Screen -->
  <div class="screen" id="sceneScreen">
    <div class="scene-header">å ´é¢ã‚’é¸ã‚“ã§ãã ã•ã„</div>
    <div class="scene-list" id="sceneList">
      <div class="scene-card" data-scene="solo">
        <span class="sc-icon">ğŸ»</span>
        <div class="sc-title">ã‚½ãƒ­ãƒ»æ—‹å¾‹</div>
        <div class="sc-sub">ç„¡ä¼´å¥ã®å˜æ—‹å¾‹ã€‚ãƒ”ã‚¿ã‚´ãƒ©ã‚¹å¾‹åŸºæº–ã§è¯ã‚„ã‹ã«</div>
      </div>
      <div class="scene-card" data-scene="double">
        <span class="sc-icon">ğŸµ</span>
        <div class="sc-title">é‡éŸ³ãƒ»å’ŒéŸ³</div>
        <div class="sc-sub">ç´”æ­£å¾‹åŸºæº–ã€‚1éŸ³ãšã¤åˆ†æ•£å’ŒéŸ³ã§ç¢ºèª</div>
      </div>
      <div class="scene-card" data-scene="piano">
        <span class="sc-icon">ğŸ¹</span>
        <div class="sc-title">ãƒ”ã‚¢ãƒä¼´å¥</div>
        <div class="sc-sub">å¹³å‡å¾‹åŸºæº–ã€‚ãƒ”ã‚¢ãƒã¨åˆã‚ã›ã‚‹ã¨ã</div>
      </div>
      <div class="scene-card" data-scene="ensemble">
        <span class="sc-icon">ğŸ¼</span>
        <div class="sc-title">å¼¦æ¥½åˆå¥</div>
        <div class="sc-sub">æ—‹å¾‹â‡”å’ŒéŸ³ã‚’æ‰‹å‹•åˆ‡æ›¿ã€‚å¼¦æ¥½å››é‡å¥ãªã©</div>
      </div>
      <div class="scene-card" data-scene="bach">
        <span class="sc-icon">ğŸ“œ</span>
        <div class="sc-title">ãƒãƒƒãƒç„¡ä¼´å¥</div>
        <div class="sc-sub">æ—‹å¾‹â‡”å’ŒéŸ³ã‚’æ‰‹å‹•åˆ‡æ›¿ã€‚ç„¡ä¼´å¥ã‚½ãƒŠã‚¿ï¼†ãƒ‘ãƒ«ãƒ†ã‚£ãƒ¼ã‚¿</div>
      </div>
    </div>
  </div>

  <!-- Main Tuner Screen -->
  <div class="screen" id="mainScreen">
    <div class="header">
      <button class="h-back" id="backBtn">â† å ´é¢é¸æŠ</button>
      <span class="h-scene" id="sceneTitle"></span>
      <button class="h-settings" id="settingsBtn">âš™</button>
    </div>
    <div class="content" id="mainContent">
      <!-- Toggle (ensemble/bach only) -->
      <div class="toggle-row" id="toggleRow" style="display:none">
        <button class="toggle-btn active" data-ref="melody" id="togMelody">æ—‹å¾‹</button>
        <button class="toggle-btn" data-ref="chord" id="togChord">å’ŒéŸ³</button>
      </div>
      <!-- Zone Bar -->
      <div class="card">
        <canvas id="zoneCanvas"></canvas>
      </div>
      <!-- Note Display -->
      <div class="card">
        <div id="noSound" class="no-sound">éŸ³ã‚’å‡ºã—ã¦ãã ã•ã„</div>
        <div id="noteDisplay" style="display:none">
          <div class="note-display">
            <div class="note-kana" id="noteKana"></div>
            <div class="note-name" id="noteName"></div>
            <div class="note-interval" id="noteInterval"></div>
            <div class="note-cents-row" id="noteCentsRow"></div>
          </div>
        </div>
      </div>
      <!-- Staff -->
      <div class="card">
        <canvas id="staffCanvas"></canvas>
      </div>
      <!-- Learning Card -->
      <div id="learnCardArea"></div>
    </div>
  </div>

  <!-- Settings Screen -->
  <div class="screen" id="settingsScreen">
    <button class="settings-back" id="settingsBack">â† æˆ»ã‚‹</button>
    <div class="settings-title">è¨­å®š</div>
    <div class="setting-group">
      <div class="setting-label">åŸºæº–ãƒ”ãƒƒãƒ (A4)</div>
      <div class="setting-options" id="pitchOptions">
        <button class="setting-opt" data-val="440">440 Hz</button>
        <button class="setting-opt" data-val="441">441 Hz</button>
        <button class="setting-opt active" data-val="442">442 Hz</button>
        <button class="setting-opt" data-val="443">443 Hz</button>
      </div>
    </div>
    <div class="setting-group">
      <div class="setting-label">æ­£è§£ã‚¾ãƒ¼ãƒ³å¹…</div>
      <div class="setting-options" id="zoneOptions">
        <button class="setting-opt" data-val="4">Â±4 cent</button>
        <button class="setting-opt active" data-val="7">Â±7 cent</button>
        <button class="setting-opt" data-val="10">Â±10 cent</button>
      </div>
    </div>
    <div class="setting-group">
      <div class="setting-toggle">
        <span class="st-label">ã‚»ãƒ³ãƒˆå€¤ã‚’è¡¨ç¤º</span>
        <button class="switch on" id="swCents"></button>
      </div>
      <div class="setting-toggle">
        <span class="st-label">éŸ³ç¨‹åº¦æ•°ã‚’è¡¨ç¤º</span>
        <button class="switch on" id="swInterval"></button>
      </div>
      <div class="setting-toggle">
        <span class="st-label">å­¦ç¿’ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º</span>
        <button class="switch on" id="swLearnCard"></button>
      </div>
    </div>
  </div>

</div>

<script>
(function(){
'use strict';

// ===== roundRect polyfill (iOS 15) =====
if(typeof CanvasRenderingContext2D.prototype.roundRect==='undefined'){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    if(typeof r==='number') r=[r];
    var tl=r[0]||0;
    this.moveTo(x+tl,y);
    this.arcTo(x+w,y,x+w,y+h,tl);
    this.arcTo(x+w,y+h,x,y+h,tl);
    this.arcTo(x,y+h,x,y,tl);
    this.arcTo(x,y,x+w,y,tl);
    this.closePath();
  };
}

// ===== SETTINGS (localStorage) =====
var DEFAULTS={a4:442,zone:7,showCents:true,showInterval:true,showLearnCard:true};
var settings=loadSettings();

function loadSettings(){
  try{var s=JSON.parse(localStorage.getItem('proTunerSettings'));return Object.assign({},DEFAULTS,s);}
  catch(e){return Object.assign({},DEFAULTS);}
}
function saveSettings(){localStorage.setItem('proTunerSettings',JSON.stringify(settings));}

// ===== CONSTANTS =====
var A4=settings.a4;

// Chromatic note names (ET reference)
var NOTE_NAMES=[
  {b:'C',a:'',k:'ãƒ‰'},{b:'C',a:'â™¯',k:'ãƒ‰â™¯'},{b:'D',a:'',k:'ãƒ¬'},
  {b:'D',a:'â™¯',k:'ãƒ¬â™¯'},{b:'E',a:'',k:'ãƒŸ'},{b:'F',a:'',k:'ãƒ•ã‚¡'},
  {b:'F',a:'â™¯',k:'ãƒ•ã‚¡â™¯'},{b:'G',a:'',k:'ã‚½'},{b:'G',a:'â™¯',k:'ã‚½â™¯'},
  {b:'A',a:'',k:'ãƒ©'},{b:'A',a:'â™¯',k:'ãƒ©â™¯'},{b:'B',a:'',k:'ã‚·'}
];

// Staff position: semitones from C -> staff position (C=0,D=1,E=2,F=3,G=4,A=5,B=6)
var SEMI_TO_STAFF=[0,0,1,1,2,3,3,4,4,5,5,6];
var STAFF_POS_Y=[0,1,2,3,4,5,6]; // C,D,E,F,G,A,B -> line/space index

// Open strings (semitone index from C0)
var OPEN_STRINGS=[
  {name:'G',oct:3,semi:55,kana:'ã‚½',color:'#4f8cff'},  // G3
  {name:'D',oct:4,semi:62,kana:'ãƒ¬',color:'#f5a623'},  // D4
  {name:'A',oct:4,semi:69,kana:'ãƒ©',color:'#e74c3c'},  // A4
  {name:'E',oct:5,semi:76,kana:'ãƒŸ',color:'#2ecc71'}   // E5
];

// Interval names (semitones from open string)
var INTERVAL_NAMES=[
  'å®Œå…¨1åº¦','çŸ­2åº¦','é•·2åº¦','çŸ­3åº¦','é•·3åº¦','å®Œå…¨4åº¦',
  'å¢—4åº¦/æ¸›5åº¦','å®Œå…¨5åº¦','çŸ­6åº¦','é•·6åº¦','çŸ­7åº¦','é•·7åº¦','å®Œå…¨8åº¦',
  'çŸ­9åº¦','é•·9åº¦','çŸ­10åº¦','é•·10åº¦','å®Œå…¨11åº¦'
];

// Interval offsets in cents from ET
// [chord(JI), piano(ET), melody(Pythagorean)]
// Index = semitones from nearest lower open string
var INTERVAL_OFFSETS=[
  [0,0,0],          // 0: P1 â€” all same
  [12,0,-10],       // 1: m2 â€” JI 16/15=+12, Pyth 256/243=-10
  [4,0,4],          // 2: M2 â€” JI 9/8=+4, Pyth 9/8=+4
  [16,0,6],         // 3: m3 â€” JI 6/5=+16, Pyth 32/27=+6
  [-14,0,-8],       // 4: M3 â€” JI 5/4=-14, Pyth 81/64=-8 (Pyth high, JI low)
  [-2,0,-2],        // 5: P4 â€” JI 4/3=-2, Pyth 4/3=-2
  [-10,0,-6],       // 6: TT â€” JI 45/32=-10, Pyth 729/512=-6 (approx)
  [2,0,2],          // 7: P5 â€” JI 3/2=+2, Pyth 3/2=+2
  [14,0,-8],        // 8: m6 â€” JI 8/5=+14, Pyth=-8 (approx)
  [-16,0,6],        // 9: M6 â€” JI 5/3=-16, Pyth=+6 (approx)
  [18,0,-4],        // 10: m7 â€” JI 16/9=+18 (approx 7/4=-31), Pyth=-4
  [-12,0,10],       // 11: M7 â€” JI 15/8=-12, Pyth=+10
];

// Scene definitions
var SCENES={
  solo:   {title:'ã‚½ãƒ­ãƒ»æ—‹å¾‹',   ref:'melody', hasToggle:false},
  double: {title:'é‡éŸ³ãƒ»å’ŒéŸ³',   ref:'chord',  hasToggle:false},
  piano:  {title:'ãƒ”ã‚¢ãƒä¼´å¥',   ref:'piano',  hasToggle:false},
  ensemble:{title:'å¼¦æ¥½åˆå¥',    ref:'melody', hasToggle:true},
  bach:   {title:'ãƒãƒƒãƒç„¡ä¼´å¥', ref:'melody', hasToggle:true}
};

// Ref index: chord=0, piano=1, melody=2
var REF_INDEX={chord:0,piano:1,melody:2};
var REF_LABELS={chord:'å’ŒéŸ³(ç´”æ­£å¾‹)',piano:'ãƒ”ã‚¢ãƒ(å¹³å‡å¾‹)',melody:'æ—‹å¾‹(ãƒ”ã‚¿ã‚´ãƒ©ã‚¹å¾‹)'};
var REF_COLORS={chord:'#f5a623',piano:'#667',melody:'#4f8cff'};

// ===== LEARNING CARDS =====
var LEARN_CARDS=[
  {id:'m3_ji',intervals:[3],refs:['chord'],text:'çŸ­3åº¦ã¯ç´”æ­£å¾‹ã ã¨ETã‚ˆã‚Š16ã‚»ãƒ³ãƒˆé«˜ã‚ã€‚éŸ¿ãã®ã€Œã†ãªã‚Šã€ãŒæ¶ˆãˆã‚‹ä½ç½®ã‚’æ¢ã—ã¾ã—ã‚‡ã†ã€‚'},
  {id:'M3_ji',intervals:[4],refs:['chord'],text:'é•·3åº¦ã¯ç´”æ­£å¾‹ã§ã¯ETã‚ˆã‚Š14ã‚»ãƒ³ãƒˆä½ã„ï¼ãƒ”ã‚¢ãƒã®é•·3åº¦ã¨ã¯ã‹ãªã‚Šé•ã„ã¾ã™ã€‚'},
  {id:'M3_solo',intervals:[4],refs:['melody'],text:'æ—‹å¾‹ã®é•·3åº¦ã¯ãƒ”ã‚¿ã‚´ãƒ©ã‚¹å¾‹ã§ETã‚ˆã‚Š8ã‚»ãƒ³ãƒˆä½ã‚ã€‚ã‚½ãƒ­ã§ã¯å°‘ã—é«˜ã‚ã«èã“ãˆã‚‹æ–¹ãŒè¯ã‚„ã‹ã€‚'},
  {id:'P5_pure',intervals:[7],refs:['chord','melody'],text:'å®Œå…¨5åº¦ã¯ã©ã®å¾‹ã§ã‚‚ETã‚ˆã‚Šã‚ãšã‹ã«åºƒã„ï¼ˆ+2ã‚»ãƒ³ãƒˆï¼‰ã€‚é–‹æ”¾å¼¦ã¨åˆã‚ã›ã¦ã€Œã†ãªã‚Šã€ã‚¼ãƒ­ã‚’ä½“æ„Ÿã€‚'},
  {id:'P4_pure',intervals:[5],refs:['chord','melody'],text:'å®Œå…¨4åº¦ã¯ETã‚ˆã‚Šã‚ãšã‹ã«ç‹­ã„ï¼ˆ-2ã‚»ãƒ³ãƒˆï¼‰ã€‚5åº¦ã®è£è¿”ã—ã§ã™ã€‚'},
  {id:'m2_lead',intervals:[1],refs:['melody'],text:'çŸ­2åº¦ï¼ˆå°éŸ³ã®è§£æ±ºå…ˆï¼‰ã€‚ãƒ”ã‚¿ã‚´ãƒ©ã‚¹å¾‹ã§ã¯ç‹­ã‚ï¼ˆ-10ã‚»ãƒ³ãƒˆï¼‰ã€æ¬¡ã®éŸ³ã¸å¼·ãå¼•ãå¯„ã›ã‚‰ã‚Œã¾ã™ã€‚'},
  {id:'M7_lead',intervals:[11],refs:['melody'],text:'é•·7åº¦ã¯å°éŸ³ã€‚ãƒ”ã‚¿ã‚´ãƒ©ã‚¹å¾‹ã§ã¯+10ã‚»ãƒ³ãƒˆé«˜ã‚ï¼ä¸»éŸ³ã«è¿‘ã„ã€‚è§£æ±ºã®å¼•åŠ›ã‚’æ„Ÿã˜ã¦ã€‚'},
  {id:'piano_et',intervals:[3,4],refs:['piano'],text:'ãƒ”ã‚¢ãƒä¼´å¥ã§ã¯å¹³å‡å¾‹ã«åˆã‚ã›ã¾ã™ã€‚ç´”æ­£å¾‹ã¨ã®ã€Œãšã‚Œã€ã‚’æ„Ÿã˜ã¦ã‚‚ã€ã“ã“ã¯å¦¥å”ãŒæ­£è§£ã€‚'},
  {id:'P1_tune',intervals:[0],refs:['chord','melody','piano'],text:'ãƒ¦ãƒ‹ã‚¾ãƒ³/ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã¯å…¨å¾‹å…±é€šã€‚é–‹æ”¾å¼¦ã¨å®Œå…¨ã«ä¸€è‡´ã™ã‚‹ã€Œã†ãªã‚Šã‚¼ãƒ­ã€ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚'},
  {id:'m6_ji',intervals:[8],refs:['chord'],text:'çŸ­6åº¦ã¯ç´”æ­£å¾‹ã§+14ã‚»ãƒ³ãƒˆã€‚é•·3åº¦ã®è»¢å›éŸ³ç¨‹ã§ã€åŒã˜ãç´”æ­£å¾‹ã§ã¯å¤§ããªãšã‚ŒãŒã‚ã‚Šã¾ã™ã€‚'},
  {id:'M6_ji',intervals:[9],refs:['chord'],text:'é•·6åº¦ã¯ç´”æ­£å¾‹ã§-16ã‚»ãƒ³ãƒˆã€‚çŸ­3åº¦ã®è»¢å›éŸ³ç¨‹ã§ã™ã€‚'},
  {id:'tt_color',intervals:[6],refs:['melody'],text:'å¢—4åº¦/æ¸›5åº¦ï¼ˆãƒˆãƒ©ã‚¤ãƒˆãƒ¼ãƒ³ï¼‰ã¯æ–‡è„ˆã§éŸ³ç¨‹ãŒå¤‰ã‚ã‚‹ç‰¹æ®ŠãªéŸ³ç¨‹ã€‚è§£æ±ºå…ˆã‚’æ„è­˜ã—ã¦ã€‚'},
  {id:'ens_toggle',intervals:null,refs:null,scene:['ensemble'],text:'å¼¦æ¥½åˆå¥ã§ã¯ã€æ—‹å¾‹ã‚’å¼¾ãã¨ãã¨å’ŒéŸ³ã‚’å¼¾ãã¨ãã§éŸ³ç¨‹ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚ä¸Šã®ãƒˆã‚°ãƒ«ã§åˆ‡æ›¿ã‚’ã€‚'},
  {id:'bach_toggle',intervals:null,refs:null,scene:['bach'],text:'ãƒãƒƒãƒç„¡ä¼´å¥ã§ã¯å’ŒéŸ³â†’æ—‹å¾‹ãŒé »ç¹ã«äº¤æ›¿ã—ã¾ã™ã€‚å’ŒéŸ³ã¯ç´”æ­£å¾‹ã€æ—‹å¾‹ã¯ãƒ”ã‚¿ã‚´ãƒ©ã‚¹å¾‹ãŒåŸºæœ¬ã€‚'},
  {id:'general_listen',intervals:null,refs:null,text:'éŸ³ç¨‹ã¯ã€Œæ­£ã—ã„ä½ç½®ã€ã‚ˆã‚Šã€ŒéŸ¿ãã‚’è´ãã€ã“ã¨ãŒå¤§åˆ‡ã€‚æ•°å€¤ã¯ã‚ãã¾ã§ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚'},
];

// ===== STATE =====
var audioCtx=null,analyser=null,audioBuf=null;
var isRunning=false;
var currentScreen='start'; // start, scene, main, settings
var currentScene=null; // solo,double,piano,ensemble,bach
var activeRef='melody'; // melody,chord,piano
var smoothPitch=0,silCnt=0;
var zoneCtx=null,staffCtx=null;
var zW=0,zH=70,sW=0,sH=190;
var lastDetected=null; // {semi,freq,octave,noteIdx,cents}
var holdTimer=0,holdNote=-1; // for learning card trigger
var shownCards={},cardCount={};
var currentCard=null,cardFadeTimer=null;

// ===== YIN =====
function yin(buf,sr){
  var th=0.15,half=Math.floor(buf.length/2);
  var tMin=Math.floor(sr/1100),tMax=Math.min(Math.ceil(sr/160),half);
  var diff=new Float32Array(half);
  for(var t=0;t<tMax;t++){
    var s=0;
    for(var i=0;i<half;i++){var d=buf[i]-buf[i+t];s+=d*d;}
    diff[t]=s;
  }
  var cm=new Float32Array(half);cm[0]=1;var run=0;
  for(var t=1;t<tMax;t++){run+=diff[t];cm[t]=diff[t]*t/run;}
  var est=-1;
  for(var t=tMin;t<tMax;t++){
    if(cm[t]<th){
      while(t+1<tMax&&cm[t+1]<cm[t])t++;
      est=t;break;
    }
  }
  if(est<0)return -1;
  var x0=est>0?est-1:est,x2=est+1<half?est+1:est,bt;
  if(x0===est)bt=cm[est]<=cm[x2]?est:x2;
  else if(x2===est)bt=cm[est]<=cm[x0]?est:x0;
  else{var a=cm[x0],b=cm[est],c=cm[x2];bt=est+(c-a)/(2*(2*b-c-a));}
  return sr/bt;
}

// ===== HELPERS =====
function rms(buf){var s=0;for(var i=0;i<buf.length;i++)s+=buf[i]*buf[i];return Math.sqrt(s/buf.length);}
function centsFromFreq(f,t){return 1200*Math.log2(f/t);}

// Get ET frequency for a semitone index (A4=69)
function etFreq(semi){return A4*Math.pow(2,(semi-69)/12);}

// Detect note from frequency
function detectNote(freq){
  if(freq<=0)return null;
  // Find nearest ET semitone
  var semi=Math.round(12*Math.log2(freq/A4)+69);
  var etF=etFreq(semi);
  var centsOff=centsFromFreq(freq,etF);
  var noteIdx=((semi%12)+12)%12;
  var octave=Math.floor(semi/12)-1;
  // Find nearest open string below
  var bestStr=null,bestDist=999;
  for(var i=0;i<OPEN_STRINGS.length;i++){
    var d=semi-OPEN_STRINGS[i].semi;
    if(d>=0&&d<bestDist){bestDist=d;bestStr=i;}
  }
  // If above all strings by >18 semitones or below G3, try closest
  if(bestStr===null||bestDist>18){
    for(var i=0;i<OPEN_STRINGS.length;i++){
      var d=Math.abs(semi-OPEN_STRINGS[i].semi);
      if(d<bestDist){bestDist=d;bestStr=i;bestDist=semi-OPEN_STRINGS[i].semi;}
    }
  }
  var intervalSemi=bestDist;
  if(intervalSemi<0)intervalSemi=0;
  if(intervalSemi>11)intervalSemi=intervalSemi%12;
  return {
    semi:semi,freq:freq,octave:octave,noteIdx:noteIdx,
    centsFromET:centsOff,
    openStr:bestStr,intervalSemi:intervalSemi,
    etFreq:etF
  };
}

// Get the target offset for current ref and interval
function getTargetOffset(intervalSemi,ref){
  if(intervalSemi<0||intervalSemi>=INTERVAL_OFFSETS.length)return 0;
  var ri=REF_INDEX[ref];
  if(ri===undefined)ri=1;
  return INTERVAL_OFFSETS[intervalSemi][ri];
}

// ===== CANVAS HELPERS =====
function dprCanvas(canvas,w,h){
  var dpr=window.devicePixelRatio||1;
  canvas.style.width=w+'px';
  canvas.style.height=h+'px';
  canvas.width=Math.round(w*dpr);
  canvas.height=Math.round(h*dpr);
  var ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  return ctx;
}

// ===== ZONE BAR DRAWING =====
function setupZone(){
  var c=document.getElementById('zoneCanvas');
  if(!c)return;
  var pw=c.parentElement.clientWidth-36;
  zW=Math.max(pw,200);
  zH=70;
  zoneCtx=dprCanvas(c,zW,zH);
  drawZone(null);
}

function drawZone(det){
  var ctx=zoneCtx;if(!ctx)return;
  var w=zW,h=zH;
  ctx.clearRect(0,0,w,h);

  var mx=20,ml=mx,mr=w-mx,mw=mr-ml;
  var cy=h*0.42,bh=5,cx=ml+mw/2;
  var range=60; // Â±60 cents displayed

  // Bar background
  ctx.fillStyle='#1a1d32';
  ctx.beginPath();ctx.roundRect(ml,cy-bh/2,mw,bh,[bh/2]);ctx.fill();

  // Get interval offsets for all 3 refs
  var intervalSemi=det?det.intervalSemi:0;
  var offsets=[
    INTERVAL_OFFSETS[intervalSemi]?INTERVAL_OFFSETS[intervalSemi][0]:0,
    INTERVAL_OFFSETS[intervalSemi]?INTERVAL_OFFSETS[intervalSemi][1]:0,
    INTERVAL_OFFSETS[intervalSemi]?INTERVAL_OFFSETS[intervalSemi][2]:0
  ];
  var refs=['chord','piano','melody'];
  var refCols=[REF_COLORS.chord,REF_COLORS.piano,REF_COLORS.melody];

  // Active ref index
  var ari=REF_INDEX[activeRef];

  // Draw correct zone (for active ref)
  var zoneW=settings.zone;
  var zoneCenter=offsets[ari];
  var zcX=cx+zoneCenter/range*(mw/2);
  var zwPx=zoneW/range*(mw/2);
  ctx.fillStyle=REF_COLORS[activeRef]+'18';
  ctx.beginPath();ctx.roundRect(zcX-zwPx,cy-18,zwPx*2,36,[4]);ctx.fill();

  // Draw 3 reference markers
  for(var i=0;i<3;i++){
    var ox=cx+offsets[i]/range*(mw/2);
    var isActive=i===ari;
    ctx.strokeStyle=refCols[i];
    ctx.lineWidth=isActive?2:1;
    ctx.globalAlpha=isActive?1:0.4;
    ctx.beginPath();ctx.moveTo(ox,cy-14);ctx.lineTo(ox,cy+14);ctx.stroke();
    ctx.globalAlpha=1;
    // Label
    ctx.fillStyle=refCols[i];
    ctx.globalAlpha=isActive?0.8:0.3;
    ctx.font='9px -apple-system,sans-serif';
    ctx.textAlign='center';ctx.textBaseline='top';
    var labels=['JI','ET','Pyth'];
    ctx.fillText(labels[i],ox,cy+17);
    ctx.globalAlpha=1;
  }

  // Ticks
  for(var t=-60;t<=60;t+=10){
    if(t===0){
      // Center tick (ET reference)
    }
    var x=ml+mw*(t+range)/(range*2);
    ctx.strokeStyle='#262940';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(x,cy-4);ctx.lineTo(x,cy+4);ctx.stroke();
  }

  // Labels
  ctx.fillStyle='#445';ctx.font='10px -apple-system,sans-serif';
  ctx.textBaseline='bottom';
  ctx.textAlign='left';ctx.fillText('â™­ ä½ã„',ml,h-2);
  ctx.textAlign='right';ctx.fillText('â™¯ é«˜ã„',mr,h-2);

  if(!det)return;

  // Detected pitch position: centsFromET relative to ET center
  var centsPos=det.centsFromET;
  var cl=Math.max(-range,Math.min(range,centsPos));
  var ix=ml+mw*(cl+range)/(range*2);

  // Determine color based on distance from active ref target
  var distFromTarget=Math.abs(centsPos-zoneCenter);
  var col=distFromTarget<=zoneW?'#2ecc71':distFromTarget<=zoneW*2?'#f5a623':'#e74c3c';

  // Glow
  var g=ctx.createRadialGradient(ix,cy,0,ix,cy,20);
  g.addColorStop(0,col+'55');g.addColorStop(1,col+'00');
  ctx.fillStyle=g;ctx.fillRect(ix-20,cy-20,40,40);

  // Indicator dot
  ctx.beginPath();ctx.arc(ix,cy,6,0,Math.PI*2);
  ctx.fillStyle=col;ctx.fill();
  ctx.beginPath();ctx.arc(ix-1.5,cy-1.5,2,0,Math.PI*2);
  ctx.fillStyle='rgba(255,255,255,0.25)';ctx.fill();
}

// ===== STAFF DRAWING =====
var LS=14,HS=LS/2;

function staffY(pos,bly){return bly-pos*HS;}

function setupStaff(){
  var c=document.getElementById('staffCanvas');
  if(!c)return;
  var pw=c.parentElement.clientWidth-36;
  sW=Math.max(pw,200);
  sH=190;
  staffCtx=dprCanvas(c,sW,sH);
  drawStaff(null);
}

// Convert detected note to staff position
// E4 = staffPos 0 (bottom line), F4=1, G4=2, A4=3, B4=4, C5=5, D5=6, E5=7, F5=8
function noteToStaffPos(det){
  if(!det)return null;
  var noteIdx=det.noteIdx;
  var octave=det.octave;
  var staffNote=SEMI_TO_STAFF[noteIdx]; // 0-6 for C-B
  // Staff position relative to E4 (bottom line of treble clef)
  // E4: noteIdx=4, oct=4 => staffPos=0
  var pos=(octave-4)*7+staffNote-2; // E=2 in 0-indexed C=0
  return pos;
}

function noteHasSharp(det){
  if(!det)return false;
  var a=NOTE_NAMES[det.noteIdx].a;
  return a==='â™¯';
}

function drawStaff(det){
  var ctx=staffCtx;if(!ctx)return;
  ctx.clearRect(0,0,sW,sH);

  var sl=50,sr=sW-16;
  var bly=sH*0.72;

  // 5 staff lines
  ctx.strokeStyle='#2a2d44';ctx.lineWidth=1;
  for(var i=0;i<5;i++){
    var y=bly-i*LS;
    ctx.beginPath();ctx.moveTo(sl,y);ctx.lineTo(sr,y);ctx.stroke();
  }

  // Treble clef
  drawClef(ctx,sl,bly);

  if(!det)return;

  var sp=noteToStaffPos(det);
  if(sp===null)return;

  var nx=(sl+sr)/2+8;
  var ny=staffY(sp,bly);
  var nr=HS*1.3;

  // Ledger lines below staff (pos -2, -4, ...)
  ctx.strokeStyle='#3a3d55';ctx.lineWidth=1;
  if(sp<0){
    for(var p=-2;p>=sp;p-=2){
      var ly=staffY(p,bly);
      ctx.beginPath();ctx.moveTo(nx-nr*2,ly);ctx.lineTo(nx+nr*2,ly);ctx.stroke();
    }
  }
  // Ledger lines above staff (pos 10, 12, ...)
  if(sp>8){
    for(var p=10;p<=sp;p+=2){
      var ly=staffY(p,bly);
      ctx.beginPath();ctx.moveTo(nx-nr*2,ly);ctx.lineTo(nx+nr*2,ly);ctx.stroke();
    }
  }

  // Accidental
  if(noteHasSharp(det)){
    ctx.fillStyle='#aab';
    ctx.font='bold '+(LS*1.2)+'px -apple-system,sans-serif';
    ctx.textAlign='right';ctx.textBaseline='middle';
    ctx.fillText('â™¯',nx-nr-6,ny+1);
  }

  // Note head
  ctx.save();
  ctx.translate(nx,ny);ctx.rotate(-0.3);
  ctx.beginPath();ctx.ellipse(0,0,nr,nr*0.72,0,0,Math.PI*2);
  ctx.fillStyle='#eef';ctx.fill();
  ctx.restore();

  // Stem
  var sh=LS*3.5;
  ctx.strokeStyle='#eef';ctx.lineWidth=1.5;
  ctx.beginPath();
  if(sp<4){
    ctx.moveTo(nx+nr*0.9,ny);ctx.lineTo(nx+nr*0.9,ny-sh);
  }else{
    ctx.moveTo(nx-nr*0.9,ny);ctx.lineTo(nx-nr*0.9,ny+sh);
  }
  ctx.stroke();
}

function drawClef(ctx,sl,bly){
  var fs=LS*5.8;
  ctx.save();
  ctx.font=fs+'px Times,serif';
  ctx.fillStyle='#3a4060';
  ctx.textBaseline='alphabetic';
  var gLineY=bly-LS;
  var tx=sl+4;
  var ty=gLineY+fs*0.36;
  var m=ctx.measureText('\uD834\uDD1E');
  if(m.width>2){
    ctx.fillText('\uD834\uDD1E',tx,ty);
  }else{
    ctx.font='bold '+(LS*1.5)+'px serif';
    ctx.fillStyle='#334';
    ctx.textBaseline='middle';
    ctx.textAlign='center';
    ctx.fillText('G',sl+20,gLineY);
  }
  ctx.restore();
}

// ===== LEARNING CARD SYSTEM =====
function tryShowLearnCard(det){
  if(!settings.showLearnCard)return;
  if(!det)return;

  var now=Date.now();
  // Check hold time (0.5s)
  if(det.semi===holdNote){
    if(now-holdTimer<500)return;
  }else{
    holdNote=det.semi;holdTimer=now;return;
  }

  // Find matching card
  for(var i=0;i<LEARN_CARDS.length;i++){
    var c=LEARN_CARDS[i];
    // Check show count
    if((cardCount[c.id]||0)>=2)continue;

    var match=false;
    // Scene-specific cards
    if(c.scene){
      if(c.scene.indexOf(currentScene)>=0)match=true;
      else continue;
    }
    // Interval + ref match
    if(c.intervals!==null&&c.refs!==null){
      if(c.intervals.indexOf(det.intervalSemi)>=0&&c.refs.indexOf(activeRef)>=0)match=true;
    }
    // General cards (no interval/ref/scene filter)
    if(c.intervals===null&&c.refs===null&&!c.scene){
      // Show randomly with low probability
      if(Math.random()<0.02)match=true;
    }

    if(match&&!shownCards[c.id+'_'+det.semi]){
      showLearnCard(c,det.semi);
      break;
    }
  }
}

function showLearnCard(card,semi){
  shownCards[card.id+'_'+semi]=true;
  cardCount[card.id]=(cardCount[card.id]||0)+1;

  var area=document.getElementById('learnCardArea');
  area.innerHTML='<div class="learn-card" id="activeLearnCard">'+card.text+'</div>';
  currentCard=card.id;

  if(cardFadeTimer)clearTimeout(cardFadeTimer);
  cardFadeTimer=setTimeout(function(){
    var el=document.getElementById('activeLearnCard');
    if(el)el.classList.add('fade-out');
    setTimeout(function(){
      var el2=document.getElementById('activeLearnCard');
      if(el2)el2.remove();
    },500);
  },4000);
}

// ===== SCREEN NAVIGATION =====
function showScreen(name){
  currentScreen=name;
  document.getElementById('startScreen').style.display=name==='start'?'flex':'none';
  ['sceneScreen','mainScreen','settingsScreen'].forEach(function(id){
    var el=document.getElementById(id);
    el.classList.toggle('visible',id===name+'Screen');
  });
  if(name==='main'){
    setTimeout(function(){setupZone();setupStaff();},30);
  }
}

function selectScene(scene){
  currentScene=scene;
  var sc=SCENES[scene];
  activeRef=sc.ref;
  document.getElementById('sceneTitle').textContent=sc.title;
  document.getElementById('toggleRow').style.display=sc.hasToggle?'flex':'none';
  // Reset toggle state
  if(sc.hasToggle){
    activeRef='melody';
    document.getElementById('togMelody').classList.add('active');
    document.getElementById('togChord').classList.remove('active');
  }
  showScreen('main');
}

// ===== AUDIO =====
async function startAudio(){
  var errEl=document.getElementById('errorMsg');
  try{
    if(location.protocol!=='https:'&&location.hostname!=='localhost'&&location.hostname!=='127.0.0.1'&&location.hostname!==''){
      errEl.textContent='HTTPSç’°å¢ƒãŒå¿…è¦ã§ã™ã€‚https://ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚';
      errEl.style.display='block';return;
    }
    if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){
      errEl.textContent='ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒã‚¤ã‚¯å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚';
      errEl.style.display='block';return;
    }
    var AC=window.AudioContext||window.webkitAudioContext;
    if(!AC){errEl.textContent='Web Audio APIéå¯¾å¿œ';errEl.style.display='block';return;}

    audioCtx=new AC();
    await audioCtx.resume();
    var stream=await navigator.mediaDevices.getUserMedia({
      audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}
    });
    var src=audioCtx.createMediaStreamSource(stream);
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=4096;
    src.connect(analyser);
    audioBuf=new Float32Array(analyser.fftSize);
    isRunning=true;

    showScreen('scene');
    tick();
  }catch(e){
    errEl.textContent=e.name==='NotAllowedError'
      ?'ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚è¨­å®šã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„ã€‚'
      :'ãƒã‚¤ã‚¯åˆæœŸåŒ–å¤±æ•—: '+e.message;
    errEl.style.display='block';
  }
}

function tick(){
  if(!isRunning)return;
  analyser.getFloatTimeDomainData(audioBuf);
  var r=rms(audioBuf);
  if(r<0.01){
    silCnt++;
    if(silCnt>15){smoothPitch=0;updateDisplay(null);}
  }else{
    silCnt=0;
    var f=yin(audioBuf,audioCtx.sampleRate);
    if(f>150&&f<2100){
      if(smoothPitch===0||Math.abs(centsFromFreq(f,smoothPitch))>80)smoothPitch=f;
      else smoothPitch=smoothPitch*0.7+f*0.3;
      var det=detectNote(smoothPitch);
      updateDisplay(det);
    }
  }
  requestAnimationFrame(tick);
}

function updateDisplay(det){
  if(currentScreen!=='main')return;

  var ns=document.getElementById('noSound');
  var nd=document.getElementById('noteDisplay');

  if(!det){
    ns.style.display='block';nd.style.display='none';
    lastDetected=null;
    drawZone(null);drawStaff(null);
    return;
  }

  ns.style.display='none';nd.style.display='block';
  lastDetected=det;

  // Note name
  var nn=NOTE_NAMES[det.noteIdx];
  document.getElementById('noteKana').textContent=nn.k;
  document.getElementById('noteName').textContent=nn.b+(nn.a||'')+det.octave;

  // Interval
  if(settings.showInterval&&det.openStr!==null){
    var os=OPEN_STRINGS[det.openStr];
    var intName=INTERVAL_NAMES[det.intervalSemi]||'';
    document.getElementById('noteInterval').textContent=intName+'ï¼ˆ'+os.name+'ç·šåŸºæº–ï¼‰';
    document.getElementById('noteInterval').style.display='block';
  }else{
    document.getElementById('noteInterval').style.display='none';
  }

  // Cents display
  if(settings.showCents&&det.intervalSemi!==undefined){
    var row=document.getElementById('noteCentsRow');
    var h='';
    var refList=[
      {key:'chord',label:'å’ŒéŸ³'},
      {key:'piano',label:'ET'},
      {key:'melody',label:'æ—‹å¾‹'}
    ];
    for(var i=0;i<refList.length;i++){
      var rl=refList[i];
      var off=getTargetOffset(det.intervalSemi,rl.key);
      var dist=det.centsFromET-off;
      var col=rl.key===activeRef?REF_COLORS[rl.key]:'#445';
      h+='<div class="note-cent-item">';
      h+='<span style="color:#556">'+rl.label+'</span>';
      h+='<span class="cv" style="color:'+col+'">'+(dist>=0?'+':'')+dist.toFixed(1)+'c</span>';
      h+='</div>';
    }
    row.innerHTML=h;
    row.style.display='flex';
  }else{
    document.getElementById('noteCentsRow').style.display='none';
  }

  drawZone(det);
  drawStaff(det);
  tryShowLearnCard(det);
}

// ===== SETTINGS UI =====
function initSettingsUI(){
  // Pitch options
  document.querySelectorAll('#pitchOptions .setting-opt').forEach(function(b){
    b.classList.toggle('active',parseInt(b.dataset.val)===settings.a4);
    b.addEventListener('click',function(){
      settings.a4=parseInt(b.dataset.val);
      A4=settings.a4;saveSettings();
      document.querySelectorAll('#pitchOptions .setting-opt').forEach(function(x){
        x.classList.toggle('active',parseInt(x.dataset.val)===settings.a4);
      });
    });
  });
  // Zone options
  document.querySelectorAll('#zoneOptions .setting-opt').forEach(function(b){
    b.classList.toggle('active',parseInt(b.dataset.val)===settings.zone);
    b.addEventListener('click',function(){
      settings.zone=parseInt(b.dataset.val);saveSettings();
      document.querySelectorAll('#zoneOptions .setting-opt').forEach(function(x){
        x.classList.toggle('active',parseInt(x.dataset.val)===settings.zone);
      });
    });
  });
  // Switches
  setupSwitch('swCents','showCents');
  setupSwitch('swInterval','showInterval');
  setupSwitch('swLearnCard','showLearnCard');
}

function setupSwitch(id,key){
  var el=document.getElementById(id);
  el.classList.toggle('on',settings[key]);
  el.addEventListener('click',function(){
    settings[key]=!settings[key];
    el.classList.toggle('on',settings[key]);
    saveSettings();
  });
}

// ===== EVENT LISTENERS =====
document.getElementById('startBtn').addEventListener('click',startAudio);

// Scene cards
document.querySelectorAll('.scene-card').forEach(function(c){
  c.addEventListener('click',function(){selectScene(c.dataset.scene);});
});

// Back button
document.getElementById('backBtn').addEventListener('click',function(){
  showScreen('scene');
});

// Settings
document.getElementById('settingsBtn').addEventListener('click',function(){
  showScreen('settings');
});
document.getElementById('settingsBack').addEventListener('click',function(){
  showScreen('main');
});

// Toggle melody/chord
document.getElementById('togMelody').addEventListener('click',function(){
  activeRef='melody';
  document.getElementById('togMelody').classList.add('active');
  document.getElementById('togChord').classList.remove('active');
  if(lastDetected)drawZone(lastDetected);
});
document.getElementById('togChord').addEventListener('click',function(){
  activeRef='chord';
  document.getElementById('togChord').classList.add('active');
  document.getElementById('togMelody').classList.remove('active');
  if(lastDetected)drawZone(lastDetected);
});

// Resize
window.addEventListener('resize',function(){
  if(!isRunning||currentScreen!=='main')return;
  setupZone();setupStaff();
});

// Init
initSettingsUI();

})();
</script>
</body>
</html>
