<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>プロ用音程学習チューナー</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{
  height:100%;
  font-family:-apple-system,BlinkMacSystemFont,'Hiragino Sans',sans-serif;
  background:#0d0f1a;color:#fff;overflow:hidden;
  -webkit-user-select:none;user-select:none;
  -webkit-tap-highlight-color:transparent;
  -webkit-text-size-adjust:100%;
}

/* === Layout === */
#app{display:flex;flex-direction:column;height:100%;padding-top:env(safe-area-inset-top)}
.screen{display:none;flex-direction:column;flex:1;min-height:0}
.screen.visible{display:flex}
#startScreen{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;padding:40px 24px}

/* === Start Screen === */
.start-title{color:#445;font-size:11px;margin-bottom:6px;letter-spacing:2px;font-weight:600}
.start-sub{color:#334;font-size:10px;margin-bottom:24px;text-align:center;line-height:1.6;max-width:280px}
.start-btn{
  width:130px;height:130px;border-radius:65px;
  background:#131630;border:2px solid #4f8cff40;
  color:#4f8cff;font-size:15px;font-weight:600;
  cursor:pointer;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:10px;
  transition:all .15s;font-family:inherit;
}
.start-btn:active{transform:scale(.93);border-color:#4f8cff}
.start-btn svg{width:40px;height:40px}
.start-hint{color:#445;font-size:12px;margin-top:24px;text-align:center;line-height:1.7}
.error-msg{color:#e74c3c;font-size:13px;margin-top:16px;text-align:center;line-height:1.6}

/* === Header === */
.header{
  display:flex;align-items:center;justify-content:space-between;
  padding:8px 16px;flex-shrink:0;
}
.header .h-title{font-size:14px;font-weight:600;color:#667;letter-spacing:.3px}
.header .h-settings{
  background:none;border:none;color:#556;font-size:20px;
  cursor:pointer;font-family:inherit;padding:4px 8px;
}

/* === Mode Toggle === */
.mode-row{
  display:flex;gap:0;margin:0 16px 8px;
  background:#12152a;border-radius:12px;overflow:hidden;
  border:1px solid #1e2140;
}
.mode-btn{
  flex:1;padding:10px 4px;text-align:center;
  font-size:12px;font-weight:600;color:#445;
  background:none;border:none;cursor:pointer;
  font-family:inherit;transition:all .15s;
  line-height:1.3;
}
.mode-btn .mode-label{display:block;font-size:14px;margin-bottom:1px}
.mode-btn .mode-sub{display:block;font-size:9px;font-weight:400;opacity:.6}
.mode-btn.active{color:#fff}
.mode-btn[data-mode="melody"].active{background:#4f8cff22;color:#4f8cff}
.mode-btn[data-mode="piano"].active{background:#99a2;color:#aab}
.mode-btn[data-mode="chord"].active{background:#f5a62322;color:#f5a623}
.mode-btn[data-mode="master"].active{background:#dde1;color:#dde}

/* === Drone Row (chord mode) === */
.drone-row{
  display:flex;align-items:center;gap:6px;
  margin:0 16px 8px;padding:10px 12px;
  background:#12152a;border-radius:12px;border:1px solid #1e2140;
}
.drone-label{font-size:11px;color:#556;font-weight:600;flex-shrink:0;margin-right:2px}
.drone-btn{
  flex:1;padding:8px 4px;border-radius:10px;
  font-size:16px;font-weight:700;line-height:1.2;
  background:#0d0f1a;border:1.5px solid #222540;
  color:#445;cursor:pointer;text-align:center;
  font-family:inherit;transition:all .15s;
}
.drone-btn .db-hz{display:block;font-size:8px;font-weight:400;opacity:.5;margin-top:1px}
.drone-btn.active{border-color:#f5a623;background:#f5a62318;color:#f5a623}
.drone-btn.active .db-hz{opacity:.7}

/* === Master Mode === */
.master-hz{font-size:38px;font-weight:800;text-align:center;color:#dde;line-height:1}
.master-et{font-size:14px;color:#778;text-align:center;margin-top:4px;font-weight:500}
.master-table{margin-top:8px}
.master-row{
  display:flex;align-items:center;padding:10px 4px;
  border-bottom:1px solid #1a1d30;gap:8px;
}
.master-row:last-child{border-bottom:none}
.mr-sys{flex:1;min-width:0}
.mr-sys-name{font-size:13px;font-weight:600;line-height:1.3}
.mr-sys-sub{font-size:10px;opacity:.5;font-weight:400}
.mr-ref{font-size:12px;color:#556;text-align:center;width:52px;flex-shrink:0}
.mr-diff{font-size:20px;font-weight:700;text-align:right;width:80px;flex-shrink:0}

/* === Content === */
.content{flex:1;overflow-y:auto;padding:0 16px 16px;-webkit-overflow-scrolling:touch}

/* === Card === */
.card{background:#161929;border-radius:14px;padding:16px;margin-bottom:8px}

/* === Judgment === */
.judgment{text-align:center;margin-bottom:8px}
.judgment-text{font-size:20px;font-weight:700;line-height:1.3}
.judgment-sub{font-size:13px;color:#778;margin-top:4px;font-weight:500}
.j-green{color:#2ecc71}
.j-yellow{color:#f5a623}
.j-red{color:#e74c3c}
.j-silent{color:#445}

/* === Zone Bar === */
#zoneCanvas{display:block;margin:0 auto}

/* === Note Display === */
.note-display{text-align:center}
.note-kana{font-size:48px;font-weight:800;line-height:1.1}
.note-sci{font-size:14px;color:#556;margin-top:2px}
.note-interval{font-size:15px;color:#99a;margin-top:8px;font-weight:500}
.note-interval .ni-name{color:#ccd}
.note-interval .ni-str{color:#667}
.ref-row{display:flex;justify-content:center;gap:14px;margin-top:10px}
.ref-item{text-align:center;font-size:11px;line-height:1.4}
.ref-item .ri-label{color:#445;display:block}
.ref-item .ri-val{font-size:14px;font-weight:600;display:block;margin-top:1px}
.ref-item.active .ri-val{font-weight:800}
.no-sound{color:#445;font-size:16px;text-align:center;padding:28px 0}

/* === Staff === */
#staffCanvas{display:block;margin:0 auto}

/* === Learning Card === */
.learn-card{
  background:#1a1e35;border-radius:12px;padding:14px 18px;margin-top:8px;
  font-size:13px;color:#aab;line-height:1.7;
  border-left:3px solid #4f8cff;
  transition:opacity .5s;
}
.learn-card .lc-title{font-size:11px;color:#4f8cff;font-weight:600;margin-bottom:4px;letter-spacing:.5px}
.learn-card.fade-out{opacity:0}

/* === Settings === */
.settings-back{
  display:flex;align-items:center;gap:6px;
  background:none;border:none;color:#4f8cff;font-size:14px;font-weight:500;
  cursor:pointer;font-family:inherit;padding:12px 16px;
}
.settings-title{text-align:center;font-size:16px;font-weight:700;padding:0 16px 16px;color:#dde}
.setting-group{padding:0 16px;margin-bottom:20px}
.setting-label{font-size:12px;color:#667;font-weight:600;letter-spacing:.5px;margin-bottom:8px}
.setting-options{display:flex;gap:6px;flex-wrap:wrap}
.setting-opt{
  padding:8px 16px;border-radius:10px;font-size:14px;font-weight:600;
  border:1.5px solid #222540;background:#12152a;color:#556;
  cursor:pointer;font-family:inherit;transition:all .15s;
}
.setting-opt.active{border-color:#4f8cff;background:#4f8cff18;color:#4f8cff}
.setting-toggle{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 0;border-bottom:1px solid #1a1d30;
}
.setting-toggle .st-label{font-size:14px;color:#99a}
.switch{
  width:44px;height:26px;border-radius:13px;
  background:#2a2d48;position:relative;cursor:pointer;
  transition:background .2s;border:none;padding:0;
}
.switch.on{background:#4f8cff}
.switch::after{
  content:'';position:absolute;top:3px;left:3px;
  width:20px;height:20px;border-radius:10px;
  background:#fff;transition:transform .2s;
}
.switch.on::after{transform:translateX(18px)}
</style>
</head>
<body>
<div id="app">

  <!-- Start Screen -->
  <div id="startScreen">
    <div class="start-title">PRO INTONATION TUNER</div>
    <div class="start-sub">音は数学。プロの音程は計算で再現できる。</div>
    <button class="start-btn" id="startBtn">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M12 2a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z" fill="#4f8cff"/>
        <path d="M17.5 11c0 2.76-2.24 5-5.5 5s-5.5-2.24-5.5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-1.5z" fill="#4f8cff"/>
      </svg>
      スタート
    </button>
    <p class="start-hint">マイクへのアクセスを許可してください</p>
    <p class="error-msg" id="errorMsg" style="display:none"></p>
  </div>

  <!-- Main Screen -->
  <div class="screen" id="mainScreen">
    <div class="header">
      <span class="h-title">音程チューナー</span>
      <button class="h-settings" id="settingsBtn">⚙</button>
    </div>

    <!-- Mode Toggle -->
    <div class="mode-row">
      <button class="mode-btn active" data-mode="melody">
        <span class="mode-label">旋律</span>
        <span class="mode-sub">ピタゴラス</span>
      </button>
      <button class="mode-btn" data-mode="piano">
        <span class="mode-label">平均律</span>
        <span class="mode-sub">ピアノ</span>
      </button>
      <button class="mode-btn" data-mode="chord">
        <span class="mode-label">和音</span>
        <span class="mode-sub">純正律</span>
      </button>
      <button class="mode-btn" data-mode="master">
        <span class="mode-label">マスター</span>
        <span class="mode-sub">全数値</span>
      </button>
    </div>

    <!-- Drone Reference (chord mode only) -->
    <div class="drone-row" id="droneRow" style="display:none">
      <span class="drone-label">基準音</span>
      <button class="drone-btn" data-str="0">G<span class="db-hz"></span></button>
      <button class="drone-btn" data-str="1">D<span class="db-hz"></span></button>
      <button class="drone-btn" data-str="2">A<span class="db-hz"></span></button>
      <button class="drone-btn" data-str="3">E<span class="db-hz"></span></button>
    </div>

    <div class="content" id="mainContent">
      <!-- Judgment + Zone Bar -->
      <div class="card">
        <div class="judgment">
          <div class="judgment-text j-silent" id="judgmentText">音を出してください</div>
          <div class="judgment-sub" id="judgmentSub"></div>
        </div>
        <canvas id="zoneCanvas"></canvas>
      </div>

      <!-- Note Display (normal modes) -->
      <div class="card" id="noteCard">
        <div id="noSound" class="no-sound" style="display:none"></div>
        <div id="noteDisplay" style="display:none">
          <div class="note-display">
            <div class="note-kana" id="noteKana"></div>
            <div class="note-sci" id="noteSci"></div>
            <div class="note-interval" id="noteInterval"></div>
            <div class="ref-row" id="refRow"></div>
          </div>
        </div>
      </div>

      <!-- Master Display (master mode only) -->
      <div class="card" id="masterCard" style="display:none">
        <div id="masterDisplay">
          <div class="note-display">
            <div class="note-kana" id="mNoteKana" style="font-size:32px"></div>
            <div class="note-sci" id="mNoteSci"></div>
            <div class="note-interval" id="mNoteInterval"></div>
          </div>
          <div class="master-table" id="masterTable"></div>
        </div>
      </div>

      <!-- Staff -->
      <div class="card">
        <canvas id="staffCanvas"></canvas>
      </div>

      <!-- Learning Card -->
      <div id="learnCardArea"></div>
    </div>
  </div>

  <!-- Settings Screen -->
  <div class="screen" id="settingsScreen">
    <button class="settings-back" id="settingsBack">← 戻る</button>
    <div class="settings-title">設定</div>
    <div class="setting-group">
      <div class="setting-label">基準ピッチ (A4)</div>
      <div class="setting-options" id="pitchOptions">
        <button class="setting-opt" data-val="440">440 Hz</button>
        <button class="setting-opt" data-val="441">441 Hz</button>
        <button class="setting-opt active" data-val="442">442 Hz</button>
        <button class="setting-opt" data-val="443">443 Hz</button>
      </div>
    </div>
    <div class="setting-group">
      <div class="setting-label">正解ゾーン バッファ幅</div>
      <div class="setting-options" id="zoneOptions">
        <button class="setting-opt" data-val="4">±4c きびしい</button>
        <button class="setting-opt active" data-val="7">±7c ふつう</button>
        <button class="setting-opt" data-val="10">±10c やさしい</button>
      </div>
    </div>
    <div class="setting-group">
      <div class="setting-toggle">
        <span class="st-label">セント値を表示</span>
        <button class="switch on" id="swCents"></button>
      </div>
      <div class="setting-toggle">
        <span class="st-label">音程度数を表示</span>
        <button class="switch on" id="swInterval"></button>
      </div>
      <div class="setting-toggle">
        <span class="st-label">学習カードを表示</span>
        <button class="switch on" id="swLearnCard"></button>
      </div>
    </div>
  </div>

</div>

<script>
(function(){
'use strict';

// ===== roundRect polyfill (iOS 15) =====
if(typeof CanvasRenderingContext2D.prototype.roundRect==='undefined'){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    if(typeof r==='number') r=[r];
    var tl=r[0]||0;
    this.moveTo(x+tl,y);
    this.arcTo(x+w,y,x+w,y+h,tl);
    this.arcTo(x+w,y+h,x,y+h,tl);
    this.arcTo(x,y+h,x,y,tl);
    this.arcTo(x,y,x+w,y,tl);
    this.closePath();
  };
}

// ===== SETTINGS =====
var DEFAULTS={a4:442,zone:7,showCents:true,showInterval:true,showLearnCard:true};
var settings=loadSettings();
function loadSettings(){
  try{var s=JSON.parse(localStorage.getItem('proTunerSettings'));return Object.assign({},DEFAULTS,s);}
  catch(e){return Object.assign({},DEFAULTS);}
}
function saveSettings(){localStorage.setItem('proTunerSettings',JSON.stringify(settings));}

// ===== CONSTANTS =====
var A4=settings.a4;

// ── 音程データ（完全ルール集 準拠） ──
// ji/pyth = ETからのセント偏差
// 出典: 村上曜『弦楽器の音程』、Loosen(1993)、Casals理論
var INTERVALS=[
  {name:'完全1度',      ji:  0, pyth:  0, jiR:'1:1',   pythR:'1:1',     stable:true},
  {name:'短2度',        ji: 12, pyth:-10, jiR:'16:15', pythR:'256:243', stable:false},
  {name:'長2度',        ji:  4, pyth:  4, jiR:'9:8',   pythR:'9:8',     stable:true},
  {name:'短3度',        ji: 16, pyth: -6, jiR:'6:5',   pythR:'32:27',   stable:false},
  {name:'長3度',        ji:-14, pyth:  8, jiR:'5:4',   pythR:'81:64',   stable:false},
  {name:'完全4度',      ji: -2, pyth: -2, jiR:'4:3',   pythR:'4:3',     stable:true},
  {name:'増4度/減5度',  ji:-10, pyth: 12, jiR:'45:32', pythR:'729:512', stable:false},
  {name:'完全5度',      ji:  2, pyth:  2, jiR:'3:2',   pythR:'3:2',     stable:true},
  {name:'短6度',        ji: 14, pyth: -8, jiR:'8:5',   pythR:'128:81',  stable:false},
  {name:'長6度',        ji:-16, pyth:  6, jiR:'5:3',   pythR:'27:16',   stable:false},
  {name:'短7度',        ji: -4, pyth: -4, jiR:'16:9',  pythR:'16:9',    stable:true},
  {name:'長7度',        ji:-12, pyth: 10, jiR:'15:8',  pythR:'243:128', stable:false}
];

// ── 音名 ──
var NOTE_NAMES=[
  {b:'C', a:'',  k:'ド',         staff:0},
  {b:'C', a:'♯', k:'ド♯/レ♭',   staff:0, sharp:true},
  {b:'D', a:'',  k:'レ',         staff:1},
  {b:'D', a:'♯', k:'レ♯/ミ♭',   staff:1, sharp:true},
  {b:'E', a:'',  k:'ミ',         staff:2},
  {b:'F', a:'',  k:'ファ',       staff:3},
  {b:'F', a:'♯', k:'ファ♯/ソ♭', staff:3, sharp:true},
  {b:'G', a:'',  k:'ソ',         staff:4},
  {b:'G', a:'♯', k:'ソ♯/ラ♭',   staff:4, sharp:true},
  {b:'A', a:'',  k:'ラ',         staff:5},
  {b:'A', a:'♯', k:'ラ♯/シ♭',   staff:5, sharp:true},
  {b:'B', a:'',  k:'シ',         staff:6}
];

// ── 開放弦 (MIDI semitone) ──
var OPEN_STRINGS=[
  {name:'G', semi:55, kana:'ソ', color:'#4f8cff'},
  {name:'D', semi:62, kana:'レ', color:'#f5a623'},
  {name:'A', semi:69, kana:'ラ', color:'#e74c3c'},
  {name:'E', semi:76, kana:'ミ', color:'#2ecc71'}
];

// ── 学習カード ──
var LEARN_CARDS=[
  {id:'M3_battle', iv:[4],
   title:'長3度 ── 最大の戦場',
   text:'純正律(5:4)=-14c、ピタゴラス(81:64)=+8c。差は22c（シントニック・コンマ）。和音では低く、旋律では高く取る。この22cを聴き分けられれば音程の9割は解決。'},
  {id:'m3_reverse', iv:[3],
   title:'短3度 ── 長3度と逆パターン',
   text:'純正律(6:5)=+16c（高め）、ピタゴラス(32:27)=-6c（低め）。長3度と正反対に動く。和音では高く、旋律では低く取る。差はやはり22c。'},
  {id:'M7_lead', iv:[11],
   title:'長7度 ── 導音の引力',
   text:'ピタゴラス律では+10c高めに取る。これが主音への「引力」を生む。プロのソロ演奏が表情豊かに聞こえる正体。Loosen(1993)でも確認済み。'},
  {id:'m2_semitone', iv:[1],
   title:'半音は2種類ある',
   text:'旋律的半音(ピタゴラス)=90c（狭い）。和声的半音(純正律)=112c（広い）。差は22c。導音の解決は狭い半音（90c）で弾くと引力が最大に。'},
  {id:'P5_anchor', iv:[7],
   title:'完全5度 ── 不動のアンカー',
   text:'3:2の振動数比。どの音律でもETから+2c。開放弦で常に確認できる最も安定した音程。調弦の基礎であり、全ての音程の出発点。'},
  {id:'P4_invert', iv:[5],
   title:'完全4度 ── 5度の裏返し',
   text:'4:3の振動数比。どの律でもETから-2c。5度と合わせて「安定組」。意外と5度より合わせにくいのは、低い方の音が基準になりにくいから。'},
  {id:'M6_pattern', iv:[9],
   title:'長6度 ── 短3度の転回',
   text:'純正律(5:3)=-16c、ピタゴラス(27:16)=+6c。短3度をひっくり返した音程で、数値も対称的。和音では低く、旋律では高く。'},
  {id:'m6_pattern', iv:[8],
   title:'短6度 ── 長3度の転回',
   text:'純正律(8:5)=+14c、ピタゴラス(128:81)=-8c。長3度の転回。数値も長3度と対称。和音では高く、旋律では低く。'},
  {id:'SC_unit', iv:[3,4,8,9,1,11],
   title:'シントニック・コンマ = 22c = 3.6mm',
   text:'旋律→和音に切り替えるとき、指を3.6mm（第1ポジション）ずらす。この距離がすべての音律切替の基本単位。覚えるべき最重要の数字。'},
  {id:'stable_group', iv:[0,2,5,7,10],
   title:'安定組 ── 迷わなくていい音程',
   text:'完全1度・長2度・完全4度・完全5度・短7度。純正律とピタゴラスで同じ値。どの場面でも同じ位置で弾けばOK。戦場は長3度・短3度・6度・7度。'},
  {id:'pattern_rule', iv:[3,4,8,9,1,11],
   title:'法則: 長=旋律で広く、短=旋律で狭く',
   text:'長音程・増音程は「旋律=高め、和音=低め」。短音程・減音程はその逆。差は常に約22c。これを知っていればどんな音程でも正解がわかる。'},
  {id:'piano_math', iv:null, modes:['piano'],
   title:'平均律 ── 数学的妥協',
   text:'12音を2^(1/12)で等分。全ての音程がわずかにずれている代わりに、どの調でも同じように弾ける。ピアノは固定されているから、合わせるのがこちらの仕事。'},
  {id:'math_is_all', iv:null,
   title:'音は振動数の比',
   text:'5:4の長3度は第5倍音が一致→「うなりゼロ」。81:64の長3度は倍音が微妙にずれ→「明るく推進力がある」。どちらも正解。違うのは場面だけ。'},
  {id:'loosen', iv:null,
   title:'研究: プロの耳は数学と一致',
   text:'Loosen(1993): プロ8名の無伴奏演奏を測定→ピタゴラス音階に最も近い値を演奏。プロの「良い耳」の正体は、無意識の数学的最適化だった。'},
  {id:'bow_7c', iv:null,
   title:'弓圧だけで±7cずれる',
   text:'弓圧・弓速の変化だけで±7cのピッチ変動が起きる（完全ルール集 G項）。弓を変えたら音程も微調整。これもプロが無意識にやっていること。'},
  {id:'vibrato_48c', iv:null,
   title:'ビブラートと音程',
   text:'プロの平均ビブラート幅≈48c(約1/4音)。ビブラートは音程を「ごまかす」のではなく「表現する」もの。基準ピッチが正確でないとビブラートも不正確になる。'},
  {id:'threshold_7c', iv:null,
   title:'人間の許容限界 = 7c',
   text:'7c以上ずれると「下手」に聞こえる。逆に7c以内なら「表現の範囲」。プロとアマの差はこの7cの中でどこを狙うかの精度。'},
  {id:'practice_3step', iv:null,
   title:'村上メソッド3段階',
   text:'①脳内で音程をイメージ ②一発で指を配置（出してからずらさない）③実音を聴いて答え合わせ。ずれたら「何セントずれたか」を定量的に感じ取り、脳内地図を更新。'}
];

// ===== STATE =====
var audioCtx=null,analyser=null,audioBuf=null;
var isRunning=false;
var currentScreen='start';
var activeMode='melody'; // melody, piano, chord, master
var smoothPitch=0,silCnt=0;
var zoneCtx=null,staffCtx=null;
var zW=0,zH=80,sW=0,sH=180;
var lastDet=null;
var holdTimer=0,holdSemi=-1;
var cardCount={},lastCardId=null;
var cardFadeTimer=null;

// Drone
var droneOsc=null,droneGain=null;
var droneRef=-1; // index into OPEN_STRINGS, -1=off

// Open string frequencies (pure 5th tuning from A4)
var STR_RATIOS=[4/9, 2/3, 1, 3/2]; // G,D,A,E
function openStringFreq(idx){return A4*STR_RATIOS[idx];}

function startDrone(idx){
  stopDrone();
  if(!audioCtx)return;
  droneRef=idx;
  var freq=openStringFreq(idx);
  droneOsc=audioCtx.createOscillator();
  droneGain=audioCtx.createGain();
  droneOsc.type='sine';
  droneOsc.frequency.value=freq;
  droneGain.gain.value=0.12;
  droneOsc.connect(droneGain);
  droneGain.connect(audioCtx.destination);
  droneOsc.start();
  updateDroneBtns();
}

function stopDrone(){
  if(droneOsc){try{droneOsc.stop();}catch(e){}droneOsc.disconnect();droneOsc=null;}
  if(droneGain){droneGain.disconnect();droneGain=null;}
  droneRef=-1;
  updateDroneBtns();
}

function updateDroneBtns(){
  document.querySelectorAll('.drone-btn').forEach(function(b){
    var i=parseInt(b.dataset.str);
    b.classList.toggle('active',i===droneRef);
    var hzEl=b.querySelector('.db-hz');
    if(hzEl) hzEl.textContent=openStringFreq(i).toFixed(1)+'Hz';
  });
}

// Detect note relative to a specific reference frequency (for chord mode)
function detectFromRef(freq,strIdx){
  if(freq<=0)return null;
  var refFreq=openStringFreq(strIdx);
  var centsFromRef=1200*Math.log2(freq/refFreq);
  var semiInterval=Math.round(centsFromRef/100);
  var ivSemi=((semiInterval%12)+12)%12;
  var deviation=centsFromRef-semiInterval*100;

  var semi=Math.round(12*Math.log2(freq/A4)+69);
  var noteIdx=((semi%12)+12)%12;
  var octave=Math.floor(semi/12)-1;
  var etTarget=refFreq*Math.pow(2,semiInterval/12);

  return {
    semi:semi, freq:freq, octave:octave, noteIdx:noteIdx,
    centsFromET:deviation, etFreq:etTarget,
    openStr:strIdx, ivSemi:ivSemi
  };
}

// ===== YIN =====
function yin(buf,sr){
  var th=0.15,half=Math.floor(buf.length/2);
  var tMin=Math.floor(sr/2800),tMax=Math.min(Math.ceil(sr/170),half);
  var diff=new Float32Array(half);
  for(var t=0;t<tMax;t++){
    var s=0;
    for(var i=0;i<half;i++){var d=buf[i]-buf[i+t];s+=d*d;}
    diff[t]=s;
  }
  var cm=new Float32Array(half);cm[0]=1;var run=0;
  for(var t=1;t<tMax;t++){run+=diff[t];cm[t]=diff[t]*t/run;}
  var est=-1;
  for(var t=tMin;t<tMax;t++){
    if(cm[t]<th){
      while(t+1<tMax&&cm[t+1]<cm[t])t++;
      est=t;break;
    }
  }
  if(est<0)return -1;
  var x0=est>0?est-1:est,x2=est+1<half?est+1:est,bt;
  if(x0===est)bt=cm[est]<=cm[x2]?est:x2;
  else if(x2===est)bt=cm[est]<=cm[x0]?est:x0;
  else{var a=cm[x0],b=cm[est],c=cm[x2];bt=est+(c-a)/(2*(2*b-c-a));}
  return sr/bt;
}

// ===== HELPERS =====
function rms(buf){var s=0;for(var i=0;i<buf.length;i++)s+=buf[i]*buf[i];return Math.sqrt(s/buf.length);}
function centsFrom(f,t){return 1200*Math.log2(f/t);}
function etFreq(semi){return A4*Math.pow(2,(semi-69)/12);}

function detectNote(freq){
  if(freq<=0)return null;
  var semi=Math.round(12*Math.log2(freq/A4)+69);
  var etF=etFreq(semi);
  var centsOff=centsFrom(freq,etF);
  var noteIdx=((semi%12)+12)%12;
  var octave=Math.floor(semi/12)-1;

  // 最寄り開放弦
  var bestStr=-1,bestDist=999;
  for(var i=0;i<OPEN_STRINGS.length;i++){
    var d=semi-OPEN_STRINGS[i].semi;
    if(d>=0&&d<bestDist){bestDist=d;bestStr=i;}
  }
  if(bestStr<0){bestStr=0;bestDist=semi-OPEN_STRINGS[0].semi;}
  var ivSemi=bestDist%12;

  return {
    semi:semi, freq:freq, octave:octave, noteIdx:noteIdx,
    centsFromET:centsOff, etFreq:etF,
    openStr:bestStr, ivSemi:ivSemi
  };
}

// Zone bounds for current mode
function getZone(ivSemi){
  var iv=INTERVALS[ivSemi];
  var buf=settings.zone;
  if(activeMode==='master') return null; // no zone in master mode
  if(activeMode==='melody') return {center:iv.pyth, lo:iv.pyth-buf, hi:iv.pyth+buf};
  if(activeMode==='chord')  return {center:iv.ji,   lo:iv.ji-buf,   hi:iv.ji+buf};
  return {center:0, lo:-buf, hi:buf}; // piano
}

// Judge
function judge(centsFromET,zone){
  if(!zone) return 'none'; // master mode
  if(centsFromET>=zone.lo&&centsFromET<=zone.hi) return 'in';
  var dist=centsFromET<zone.lo ? zone.lo-centsFromET : centsFromET-zone.hi;
  if(dist<=7) return 'close';
  return 'far';
}

// Position description
function describePos(centsFromET,ivSemi){
  var iv=INTERVALS[ivSemi];
  if(iv.stable){
    var d=Math.abs(centsFromET-iv.ji);
    if(d<2) return 'ぴったり！';
    return centsFromET>iv.ji ? 'やや高め' : 'やや低め';
  }
  var dJI=Math.abs(centsFromET-iv.ji);
  var dET=Math.abs(centsFromET);
  var dPy=Math.abs(centsFromET-iv.pyth);
  if(dJI<=dET&&dJI<=dPy) return '純正律（和音）寄り';
  if(dPy<=dET&&dPy<=dJI) return 'ピタゴラス（旋律）寄り';
  return '平均律（ピアノ）付近';
}

// ===== CANVAS =====
function dprCanvas(canvas,w,h){
  var dpr=window.devicePixelRatio||1;
  canvas.style.width=w+'px';
  canvas.style.height=h+'px';
  canvas.width=Math.round(w*dpr);
  canvas.height=Math.round(h*dpr);
  var ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  return ctx;
}

// ===== ZONE BAR =====
function setupZone(){
  var c=document.getElementById('zoneCanvas');
  if(!c)return;
  var pw=c.parentElement.clientWidth-32;
  zW=Math.max(pw,200);
  zH=80;
  zoneCtx=dprCanvas(c,zW,zH);
  drawZone(null);
}

function drawZone(det){
  var ctx=zoneCtx;if(!ctx)return;
  var w=zW,h=zH;
  ctx.clearRect(0,0,w,h);

  var mx=16,ml=mx,mr=w-mx,mw=mr-ml;
  var cy=h*0.40,bh=4,cx=ml+mw/2;
  var range=50;

  // Get interval data
  var ivSemi=det?det.ivSemi:4; // default M3 for display
  var iv=INTERVALS[ivSemi];

  // Bar bg
  ctx.fillStyle='#1a1d32';
  ctx.beginPath();ctx.roundRect(ml,cy-bh/2,mw,bh,[bh/2]);ctx.fill();

  // Active zone highlight
  var zone=getZone(ivSemi);
  var isMaster=activeMode==='master';
  if(zone){
    var zLoX=cx+(zone.lo/range)*(mw/2);
    var zHiX=cx+(zone.hi/range)*(mw/2);
    var modeCol=activeMode==='melody'?'#4f8cff':activeMode==='chord'?'#f5a623':'#778';
    ctx.fillStyle=modeCol+'20';
    ctx.beginPath();ctx.roundRect(zLoX,cy-20,zHiX-zLoX,40,[4]);ctx.fill();
    ctx.strokeStyle=modeCol+'40';ctx.lineWidth=1;
    ctx.beginPath();ctx.roundRect(zLoX,cy-20,zHiX-zLoX,40,[4]);ctx.stroke();
  }

  // Reference markers: [JI, ET, Pyth]
  var refs=[
    {off:iv.ji,   label:'和音', col:'#f5a623', sub:iv.jiR},
    {off:0,       label:'ET',   col:'#667',    sub:''},
    {off:iv.pyth, label:'旋律', col:'#4f8cff', sub:iv.pythR}
  ];

  for(var i=0;i<refs.length;i++){
    var r=refs[i];
    var rx=cx+(r.off/range)*(mw/2);
    var isActive=isMaster?true:(i===0&&activeMode==='chord')||(i===1&&activeMode==='piano')||(i===2&&activeMode==='melody');

    // Marker line
    ctx.strokeStyle=r.col;
    ctx.lineWidth=isMaster?1.5:isActive?2.5:1;
    ctx.globalAlpha=isMaster?0.8:isActive?1:0.35;
    ctx.beginPath();ctx.moveTo(rx,cy-16);ctx.lineTo(rx,cy+16);ctx.stroke();
    ctx.globalAlpha=1;

    // Label
    ctx.fillStyle=r.col;
    ctx.globalAlpha=isMaster?0.7:isActive?0.9:0.3;
    ctx.font=(isActive?'bold ':'')+' 9px -apple-system,sans-serif';
    ctx.textAlign='center';ctx.textBaseline='top';
    ctx.fillText(r.label,rx,cy+19);
    if(r.sub&&!iv.stable){
      ctx.font='8px -apple-system,sans-serif';
      ctx.fillText(r.sub,rx,cy+30);
    }
    ctx.globalAlpha=1;
  }

  // SC annotation (if interval has 22c gap)
  if(!iv.stable){
    var scLoX=cx+(Math.min(iv.ji,iv.pyth)/range)*(mw/2);
    var scHiX=cx+(Math.max(iv.ji,iv.pyth)/range)*(mw/2);
    ctx.strokeStyle='#ffffff12';ctx.lineWidth=1;
    ctx.setLineDash([3,3]);
    var scY=cy-24;
    ctx.beginPath();ctx.moveTo(scLoX,scY);ctx.lineTo(scHiX,scY);ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle='#ffffff18';ctx.font='7px -apple-system,sans-serif';
    ctx.textAlign='center';ctx.textBaseline='bottom';
    ctx.fillText('SC 22c',(scLoX+scHiX)/2,scY-1);
  }

  // Tick marks
  for(var t=-50;t<=50;t+=10){
    var tx=ml+mw*(t+range)/(range*2);
    ctx.strokeStyle=t===0?'#334':'#1e2138';
    ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(tx,cy-3);ctx.lineTo(tx,cy+3);ctx.stroke();
  }

  // Edge labels
  ctx.fillStyle='#334';ctx.font='9px -apple-system,sans-serif';
  ctx.textBaseline='bottom';
  ctx.textAlign='left';ctx.fillText('♭ 低い',ml,h-2);
  ctx.textAlign='right';ctx.fillText('♯ 高い',mr,h-2);

  if(!det)return;

  // Pitch indicator
  var cl=Math.max(-range,Math.min(range,det.centsFromET));
  var ix=cx+(cl/range)*(mw/2);

  var jResult=judge(det.centsFromET,zone);
  var col=jResult==='none'?'#dde':jResult==='in'?'#2ecc71':jResult==='close'?'#f5a623':'#e74c3c';

  // Glow
  var g=ctx.createRadialGradient(ix,cy,0,ix,cy,18);
  g.addColorStop(0,col+'55');g.addColorStop(1,col+'00');
  ctx.fillStyle=g;ctx.fillRect(ix-18,cy-18,36,36);

  // Dot
  ctx.beginPath();ctx.arc(ix,cy,6,0,Math.PI*2);
  ctx.fillStyle=col;ctx.fill();
  ctx.beginPath();ctx.arc(ix-1.5,cy-1.5,2,0,Math.PI*2);
  ctx.fillStyle='rgba(255,255,255,0.25)';ctx.fill();
}

// ===== STAFF =====
var LS=14,HS=LS/2;
function staffY(pos,bly){return bly-pos*HS;}

function setupStaff(){
  var c=document.getElementById('staffCanvas');
  if(!c)return;
  var pw=c.parentElement.clientWidth-32;
  sW=Math.max(pw,200);
  sH=180;
  staffCtx=dprCanvas(c,sW,sH);
  drawStaff(null);
}

function noteToStaffPos(det){
  if(!det)return null;
  var staffNote=NOTE_NAMES[det.noteIdx].staff;
  return (det.octave-4)*7+staffNote-2; // E4=0
}

function drawStaff(det){
  var ctx=staffCtx;if(!ctx)return;
  ctx.clearRect(0,0,sW,sH);

  var sl=50,sr=sW-16;
  var bly=sH*0.72;

  ctx.strokeStyle='#2a2d44';ctx.lineWidth=1;
  for(var i=0;i<5;i++){
    var y=bly-i*LS;
    ctx.beginPath();ctx.moveTo(sl,y);ctx.lineTo(sr,y);ctx.stroke();
  }

  // Clef
  var fs=LS*5.8;
  ctx.save();
  ctx.font=fs+'px Times,serif';
  ctx.fillStyle='#3a4060';
  ctx.textBaseline='alphabetic';
  var gLineY=bly-LS;
  var tx=sl+4,ty=gLineY+fs*0.36;
  var m=ctx.measureText('\uD834\uDD1E');
  if(m.width>2) ctx.fillText('\uD834\uDD1E',tx,ty);
  else{
    ctx.font='bold '+(LS*1.5)+'px serif';
    ctx.fillStyle='#334';ctx.textBaseline='middle';ctx.textAlign='center';
    ctx.fillText('G',sl+20,gLineY);
  }
  ctx.restore();

  if(!det)return;

  var sp=noteToStaffPos(det);
  if(sp===null)return;
  var nx=(sl+sr)/2+8;
  var ny=staffY(sp,bly);
  var nr=HS*1.3;

  // Ledger lines below
  ctx.strokeStyle='#3a3d55';ctx.lineWidth=1;
  if(sp<0){
    for(var p=-2;p>=sp;p-=2){
      var ly=staffY(p,bly);
      ctx.beginPath();ctx.moveTo(nx-nr*2,ly);ctx.lineTo(nx+nr*2,ly);ctx.stroke();
    }
  }
  // Middle C ledger (sp=-2)
  if(sp===-1){
    var ly=staffY(-2,bly);
    // don't draw for -1, only if sp<= -2
  }
  // Ledger lines above
  if(sp>8){
    for(var p=10;p<=sp;p+=2){
      var ly=staffY(p,bly);
      ctx.beginPath();ctx.moveTo(nx-nr*2,ly);ctx.lineTo(nx+nr*2,ly);ctx.stroke();
    }
  }

  // Accidental
  if(NOTE_NAMES[det.noteIdx].sharp){
    ctx.fillStyle='#aab';
    ctx.font='bold '+(LS*1.2)+'px -apple-system,sans-serif';
    ctx.textAlign='right';ctx.textBaseline='middle';
    ctx.fillText('♯',nx-nr-6,ny+1);
  }

  // Note head
  ctx.save();
  ctx.translate(nx,ny);ctx.rotate(-0.3);
  ctx.beginPath();ctx.ellipse(0,0,nr,nr*0.72,0,0,Math.PI*2);
  ctx.fillStyle='#eef';ctx.fill();
  ctx.restore();

  // Stem
  var sh=LS*3.5;
  ctx.strokeStyle='#eef';ctx.lineWidth=1.5;
  ctx.beginPath();
  if(sp<4){ctx.moveTo(nx+nr*0.9,ny);ctx.lineTo(nx+nr*0.9,ny-sh);}
  else{ctx.moveTo(nx-nr*0.9,ny);ctx.lineTo(nx-nr*0.9,ny+sh);}
  ctx.stroke();
}

// ===== DISPLAY UPDATE =====
function updateDisplay(det){
  if(currentScreen!=='main')return;

  var jText=document.getElementById('judgmentText');
  var jSub=document.getElementById('judgmentSub');
  var noEl=document.getElementById('noSound');
  var ndEl=document.getElementById('noteDisplay');
  var noteCard=document.getElementById('noteCard');
  var masterCard=document.getElementById('masterCard');
  var isMaster=activeMode==='master';

  // Show/hide cards based on mode
  noteCard.style.display=isMaster?'none':'block';
  masterCard.style.display=isMaster?'block':'none';

  if(!det){
    jText.textContent='音を出してください';
    jText.className='judgment-text j-silent';
    jSub.textContent='';
    noEl.style.display='none';
    ndEl.style.display='none';
    lastDet=null;
    drawZone(null);drawStaff(null);
    return;
  }

  lastDet=det;
  var iv=INTERVALS[det.ivSemi];
  var nn=NOTE_NAMES[det.noteIdx];
  var zone=getZone(det.ivSemi);
  var jResult=judge(det.centsFromET,zone);

  if(isMaster){
    // === MASTER MODE ===
    // Judgment area: show Hz + ET cents
    jText.textContent=det.freq.toFixed(1)+' Hz';
    jText.className='judgment-text';
    jText.style.color='#dde';
    jSub.textContent='ET基準: '+(det.centsFromET>=0?'+':'')+det.centsFromET.toFixed(1)+'c';

    // Master note display
    document.getElementById('mNoteKana').textContent=nn.k;
    document.getElementById('mNoteSci').textContent=nn.b+(nn.a||'')+det.octave;
    var mIntEl=document.getElementById('mNoteInterval');
    if(det.openStr>=0){
      var os=OPEN_STRINGS[det.openStr];
      mIntEl.innerHTML='<span class="ni-name">'+iv.name+'</span> <span class="ni-str">('+os.name+'線基準)</span>';
      mIntEl.style.display='block';
    }else{
      mIntEl.style.display='none';
    }

    // Master table: show all 3 systems
    var systems=[
      {name:'旋律',sub:'ピタゴラス '+iv.pythR, off:iv.pyth, col:'#4f8cff'},
      {name:'平均律',sub:'ET', off:0, col:'#778'},
      {name:'和音',sub:'純正律 '+iv.jiR, off:iv.ji, col:'#f5a623'}
    ];
    var h='';
    for(var i=0;i<systems.length;i++){
      var s=systems[i];
      var targetHz=det.etFreq*Math.pow(2,s.off/1200);
      var diff=det.centsFromET-s.off;
      var absDiff=Math.abs(diff);
      var diffCol=absDiff<3?'#2ecc71':absDiff<7?'#aab':absDiff<15?'#f5a623':'#e74c3c';
      h+='<div class="master-row">';
      h+='<div class="mr-sys"><div class="mr-sys-name" style="color:'+s.col+'">'+s.name+'</div>';
      h+='<div class="mr-sys-sub">'+s.sub+'</div></div>';
      h+='<div class="mr-ref">'+targetHz.toFixed(1)+'Hz<br><span style="font-size:10px;opacity:.6">'+(s.off>=0?'+':'')+s.off+'c</span></div>';
      h+='<div class="mr-diff" style="color:'+diffCol+'">'+(diff>=0?'+':'')+diff.toFixed(1)+'c</div>';
      h+='</div>';
    }
    document.getElementById('masterTable').innerHTML=h;
  }else{
    // === NORMAL MODES ===
    jText.style.color=''; // reset inline color
    noEl.style.display='none';
    ndEl.style.display='block';

    // Judgment text
    if(jResult==='in'){
      var pos=describePos(det.centsFromET,det.ivSemi);
      jText.textContent='正解ゾーン内！';
      jText.className='judgment-text j-green';
      jSub.textContent=pos;
    }else if(jResult==='close'){
      var dir=det.centsFromET<zone.lo;
      jText.textContent='惜しい！ もう少し'+(dir?'高く':'低く');
      jText.className='judgment-text j-yellow';
      var dist=dir?zone.lo-det.centsFromET:det.centsFromET-zone.hi;
      jSub.textContent=dist.toFixed(0)+'c '+(dir?'低い':'高い');
    }else{
      var dir=det.centsFromET<zone.lo;
      jText.textContent=dir?'低い ↑':'高い ↓';
      jText.className='judgment-text j-red';
      var dist=dir?zone.lo-det.centsFromET:det.centsFromET-zone.hi;
      jSub.textContent=dist.toFixed(0)+'c '+(dir?'低い':'高い');
    }

    // Note name
    document.getElementById('noteKana').textContent=nn.k;
    document.getElementById('noteSci').textContent=nn.b+(nn.a||'')+det.octave+'  '+det.freq.toFixed(1)+'Hz';

    // Interval
    var intEl=document.getElementById('noteInterval');
    if(settings.showInterval&&det.openStr>=0){
      var os=OPEN_STRINGS[det.openStr];
      intEl.innerHTML='<span class="ni-name">'+iv.name+'</span> <span class="ni-str">('+os.name+'線基準)</span>';
      intEl.style.display='block';
    }else{
      intEl.style.display='none';
    }

    // Reference cents
    var refEl=document.getElementById('refRow');
    if(settings.showCents){
      var refs=[
        {label:'和音',off:iv.ji,col:'#f5a623',mode:'chord'},
        {label:'ET',off:0,col:'#778',mode:'piano'},
        {label:'旋律',off:iv.pyth,col:'#4f8cff',mode:'melody'}
      ];
      var rh='';
      for(var i=0;i<refs.length;i++){
        var r=refs[i];
        var diff=det.centsFromET-r.off;
        var isAct=r.mode===activeMode;
        rh+='<div class="ref-item'+(isAct?' active':'')+'">';
        rh+='<span class="ri-label" style="color:'+(isAct?r.col:'#445')+'">'+r.label+'</span>';
        rh+='<span class="ri-val" style="color:'+(isAct?r.col:'#556')+'">'+(diff>=0?'+':'')+diff.toFixed(1)+'c</span>';
        rh+='</div>';
      }
      refEl.innerHTML=rh;
      refEl.style.display='flex';
    }else{
      refEl.style.display='none';
    }
  }

  drawZone(det);
  drawStaff(det);
  if(!isMaster) tryShowLearnCard(det);
}

// ===== LEARNING CARDS =====
function tryShowLearnCard(det){
  if(!settings.showLearnCard||!det)return;

  var now=Date.now();
  if(det.semi===holdSemi){
    if(now-holdTimer<500)return;
  }else{
    holdSemi=det.semi;holdTimer=now;return;
  }

  for(var i=0;i<LEARN_CARDS.length;i++){
    var c=LEARN_CARDS[i];
    if(c.id===lastCardId)continue;
    if((cardCount[c.id]||0)>=2)continue;

    var match=false;
    if(c.iv!==null&&c.iv.indexOf(det.ivSemi)>=0) match=true;
    if(c.modes&&c.modes.indexOf(activeMode)>=0) match=true;
    if(c.iv===null&&!c.modes&&Math.random()<0.015) match=true;

    if(match){
      showLearnCard(c);
      break;
    }
  }
}

function showLearnCard(card){
  cardCount[card.id]=(cardCount[card.id]||0)+1;
  lastCardId=card.id;
  var area=document.getElementById('learnCardArea');
  area.innerHTML='<div class="learn-card" id="activeLearnCard">'
    +'<div class="lc-title">'+card.title+'</div>'
    +card.text+'</div>';

  if(cardFadeTimer)clearTimeout(cardFadeTimer);
  cardFadeTimer=setTimeout(function(){
    var el=document.getElementById('activeLearnCard');
    if(el)el.classList.add('fade-out');
    setTimeout(function(){
      var el2=document.getElementById('activeLearnCard');
      if(el2)el2.remove();
    },600);
  },5000);
}

// ===== AUDIO =====
async function startAudio(){
  var errEl=document.getElementById('errorMsg');
  try{
    if(location.protocol!=='https:'&&location.hostname!=='localhost'&&location.hostname!=='127.0.0.1'&&location.hostname!==''){
      errEl.textContent='HTTPS環境が必要です。https://でアクセスしてください。';
      errEl.style.display='block';return;
    }
    if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){
      errEl.textContent='このブラウザはマイク入力に対応していません。';
      errEl.style.display='block';return;
    }
    var AC=window.AudioContext||window.webkitAudioContext;
    if(!AC){errEl.textContent='Web Audio API非対応';errEl.style.display='block';return;}

    audioCtx=new AC();
    await audioCtx.resume();
    var stream=await navigator.mediaDevices.getUserMedia({
      audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}
    });
    var src=audioCtx.createMediaStreamSource(stream);
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=4096;
    src.connect(analyser);
    audioBuf=new Float32Array(analyser.fftSize);
    isRunning=true;

    showScreen('main');
    tick();
  }catch(e){
    errEl.textContent=e.name==='NotAllowedError'
      ?'マイクへのアクセスが拒否されました。設定から許可してください。'
      :'マイク初期化失敗: '+e.message;
    errEl.style.display='block';
  }
}

function tick(){
  if(!isRunning)return;
  try{
    analyser.getFloatTimeDomainData(audioBuf);
    var r=rms(audioBuf);
    if(r<0.01){
      silCnt++;
      if(silCnt>15){smoothPitch=0;updateDisplay(null);}
    }else{
      silCnt=0;
      var f=yin(audioBuf,audioCtx.sampleRate);
      if(f>170&&f<3200){
        // Drone avoidance: if drone is playing and detected freq is very close to drone, skip
        if(droneRef>=0){
          var dFreq=openStringFreq(droneRef);
          if(Math.abs(centsFrom(f,dFreq))<15) f=-1; // likely picking up the drone
        }
        if(f>0){
          if(smoothPitch===0||Math.abs(centsFrom(f,smoothPitch))>80)smoothPitch=f;
          else smoothPitch=smoothPitch*0.7+f*0.3;
          // Chord mode with reference: calculate from reference
          var det;
          if(activeMode==='chord'&&droneRef>=0){
            det=detectFromRef(smoothPitch,droneRef);
          }else{
            det=detectNote(smoothPitch);
          }
          updateDisplay(det);
        }
      }
    }
  }catch(e){}
  requestAnimationFrame(tick);
}

// ===== SCREEN NAV =====
function showScreen(name){
  currentScreen=name;
  document.getElementById('startScreen').style.display=name==='start'?'flex':'none';
  document.getElementById('mainScreen').classList.toggle('visible',name==='main');
  document.getElementById('settingsScreen').classList.toggle('visible',name==='settings');
  if(name==='main') setTimeout(function(){setupZone();setupStaff();},30);
}

// ===== SETTINGS UI =====
function initSettingsUI(){
  document.querySelectorAll('#pitchOptions .setting-opt').forEach(function(b){
    b.classList.toggle('active',parseInt(b.dataset.val)===settings.a4);
    b.addEventListener('click',function(){
      settings.a4=parseInt(b.dataset.val);
      A4=settings.a4;saveSettings();
      document.querySelectorAll('#pitchOptions .setting-opt').forEach(function(x){
        x.classList.toggle('active',parseInt(x.dataset.val)===settings.a4);
      });
    });
  });
  document.querySelectorAll('#zoneOptions .setting-opt').forEach(function(b){
    b.classList.toggle('active',parseInt(b.dataset.val)===settings.zone);
    b.addEventListener('click',function(){
      settings.zone=parseInt(b.dataset.val);saveSettings();
      document.querySelectorAll('#zoneOptions .setting-opt').forEach(function(x){
        x.classList.toggle('active',parseInt(x.dataset.val)===settings.zone);
      });
      if(lastDet)drawZone(lastDet);
    });
  });
  setupSwitch('swCents','showCents');
  setupSwitch('swInterval','showInterval');
  setupSwitch('swLearnCard','showLearnCard');
}

function setupSwitch(id,key){
  var el=document.getElementById(id);
  el.classList.toggle('on',settings[key]);
  el.addEventListener('click',function(){
    settings[key]=!settings[key];
    el.classList.toggle('on',settings[key]);
    saveSettings();
  });
}

// ===== EVENT LISTENERS =====
document.getElementById('startBtn').addEventListener('click',startAudio);

// Mode toggle
document.querySelectorAll('.mode-btn').forEach(function(b){
  b.addEventListener('click',function(){
    activeMode=b.dataset.mode;
    document.querySelectorAll('.mode-btn').forEach(function(x){
      x.classList.toggle('active',x.dataset.mode===activeMode);
    });
    // Show/hide drone row
    document.getElementById('droneRow').style.display=activeMode==='chord'?'flex':'none';
    // Stop drone when leaving chord mode
    if(activeMode!=='chord') stopDrone();
    if(lastDet){drawZone(lastDet);updateDisplay(lastDet);}
  });
});

// Drone buttons
document.querySelectorAll('.drone-btn').forEach(function(b){
  b.addEventListener('click',function(){
    var idx=parseInt(b.dataset.str);
    if(droneRef===idx){
      stopDrone(); // toggle off
    }else{
      startDrone(idx);
    }
  });
});

// Settings
document.getElementById('settingsBtn').addEventListener('click',function(){showScreen('settings');});
document.getElementById('settingsBack').addEventListener('click',function(){showScreen('main');});

// Resize
window.addEventListener('resize',function(){
  if(!isRunning||currentScreen!=='main')return;
  setupZone();setupStaff();
});

// iOS AudioContext resume on visibility change
document.addEventListener('visibilitychange',function(){
  if(audioCtx&&!document.hidden){
    audioCtx.resume();
  }
});

// iOS touch to resume
document.addEventListener('touchstart',function(){
  if(audioCtx&&audioCtx.state==='suspended') audioCtx.resume();
},{passive:true});

initSettingsUI();
updateDroneBtns();

})();
</script>
</body>
</html>
